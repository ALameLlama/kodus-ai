name: "Preview: Cleanup"

# =============================================================================
# Cleans up preview environments when a PR is closed/merged.
# - Railway: deletes the PR environment
# - Vercel: auto-cleans (no action needed)
#
# Required secrets:
#   RAILWAY_TOKEN, RAILWAY_PROJECT_ID
# =============================================================================

permissions:
    contents: read

on:
    pull_request:
        types: [closed]

jobs:
    cleanup-railway:
        name: Cleanup Railway environment
        runs-on: ubuntu-latest
        env:
            RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        steps:
            - name: Install Railway CLI
              run: npm install -g @railway/cli

            - name: Delete preview environment
              run: |
                  ENV_NAME="pr-${{ github.event.pull_request.number }}"

                  railway environment delete "$ENV_NAME" \
                    --project ${{ secrets.RAILWAY_PROJECT_ID }} \
                    --yes 2>/dev/null || true

                  echo "Cleaned up Railway environment: $ENV_NAME"

    cleanup-comment:
        name: Update PR comment
        runs-on: ubuntu-latest
        permissions:
            pull-requests: write
        steps:
            - name: Mark preview as closed
              uses: actions/github-script@v7
              with:
                  script: |
                      const marker = '## Preview Environment';

                      const { data: comments } = await github.rest.issues.listComments({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        issue_number: context.issue.number,
                      });

                      const existing = comments.find(c => c.body.includes(marker));

                      if (existing) {
                        await github.rest.issues.updateComment({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          comment_id: existing.id,
                          body: `## Preview Environment\n\n~~Preview environments have been cleaned up.~~`,
                        });
                      }
