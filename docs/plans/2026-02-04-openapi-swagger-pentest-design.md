# OpenAPI + Swagger UI for Pentest (Staging/QA)

Date: 2026-02-04

## Context
Pentest requires fast API discovery. The API is a NestJS service in `apps/api`. We will publish OpenAPI spec and Swagger UI in Staging/QA only, protected by Basic Auth plus IP allowlist.

## Goals
- Provide OpenAPI JSON and Swagger UI for the pentest team.
- Restrict access to Staging/QA with Basic Auth + IP allowlist.
- Make enablement fully toggleable via environment variables.
- Keep production unaffected.

## Non-goals
- Expose docs in production.
- Provide permanent public docs.
- Rework existing auth or API architecture.

## Decisions
- Enable docs only when `API_DOCS_ENABLED=true`.
- Expose endpoints:
  - `GET /openapi.json` (OpenAPI spec)
  - `GET /docs` (Swagger UI)
- Protect both endpoints with IP allowlist and Basic Auth.
- Default to disabled when env vars are missing.

## Configuration
Proposed env vars:
- `API_DOCS_ENABLED` (true/false)
- `API_DOCS_PATH` (default: /docs)
- `API_DOCS_SPEC_PATH` (default: /openapi.json)
- `API_DOCS_IP_ALLOWLIST` (comma-separated CIDR list, e.g. 103.72.59.0/24)
- `API_DOCS_BASIC_USER`
- `API_DOCS_BASIC_PASS`
- `API_DOCS_BASE_URL` (optional, used by export script to fetch `openapi.json`)

## Security Controls
- IP allowlist middleware runs before Basic Auth.
- Basic Auth required for both `/docs` and `/openapi.json`.
- Return 403 for IP not allowed, 401 for missing/invalid Basic Auth.
- No credential data in logs.
- Optional: disable Swagger "Try it out" in UI.

## Error Handling
- If `API_DOCS_ENABLED=false`, endpoints are not registered (404).
- If allowlist fails, return 403.
- If Basic Auth fails, return 401 with `WWW-Authenticate: Basic`.

## Observability
- Log blocked access attempts at warn level with IP and path.
- Do not log credentials or full auth headers.

## Testing
- Unit tests for:
  - IP allowlist (CIDR match, X-Forwarded-For parsing).
  - Basic Auth validation.
- E2E tests for:
  - 200 when docs enabled, IP allowed, Basic Auth valid.
  - 403 for IP not allowed.
  - 401 for invalid Basic Auth.
  - 404 when docs disabled.

## Rollout
- Deploy to Staging/QA with docs enabled and allowlist set to pentest range.
- Disable docs after pentest by setting `API_DOCS_ENABLED=false`.
